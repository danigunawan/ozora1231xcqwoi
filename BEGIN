BEGIN

declare waktu varchar(100);
declare tanggal_sekarang varchar(100);
declare jam_sekarang varchar(100);
declare nama_pelanggan varchar(100);
declare ppn_input varchar(100);

declare akun_persediaan varchar(100);
declare akun_hpp_penjualan varchar(100);
declare akun_pembayaran_kredit varchar(100);
declare akun_total_penjualan varchar(100);
declare akun_pajak_jual varchar(100);
declare akun_potongan_jual varchar(100);
declare akun_pendapatan_ongkir varchar(100);


declare length_faktur varchar(100);
declare length_jadi varchar(100);

declare total_penjualann float(100,2);
declare potongan float(100,2);
declare pajak float(100,2);
declare total_hpp float(100,2);
declare total_tax float(100,2);
declare total2 float(100,2);
declare total_piutang float(100,2);
declare ongkir float(100,2);


SET tanggal_sekarang = (SELECT (DATE(NOW())));
SET jam_sekarang = (SELECT (TIME(NOW())));
SET waktu = CONCAT(new.tanggal," ",new.jam);

SET akun_persediaan = (SELECT persediaan FROM setting_akun);
SET akun_hpp_penjualan = (SELECT hpp_penjualan FROM setting_akun);
SET akun_pembayaran_kredit = (SELECT pembayaran_kredit FROM setting_akun);
SET akun_total_penjualan = (SELECT total_penjualan FROM setting_akun);
SET akun_pajak_jual = (SELECT pajak_jual FROM setting_akun);
SET akun_potongan_jual = (SELECT potongan_jual FROM setting_akun);
SET akun_pendapatan_ongkir = (SELECT pendapatan_ongkir FROM setting_akun);


SET total_hpp = (SELECT SUM(total_nilai) AS total_hpp FROM hpp_keluar WHERE no_faktur = new.no_faktur);
SET total_tax = (SELECT SUM(tax) AS total_tax FROM detail_penjualan WHERE no_faktur = new.no_faktur);
SET total2 = (SELECT SUM(subtotal) AS sub_total FROM detail_penjualan WHERE no_faktur = new.no_faktur);

SET nama_pelanggan = (SELECT nama_pelanggan FROM pelanggan WHERE kode_pelanggan = new.kode_pelanggan);
SET ppn_input = new.ppn;
SET potongan = new.potongan;
SET total_piutang = new.total - new.tunai;
SET ongkir = new.ongkir;


DELETE FROM jurnal_trans WHERE no_faktur = new.no_faktur;

  IF (new.status_jual_awal = 'Tunai') THEN

          IF (total_hpp != "" || total_hpp != 0) THEN

                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_persediaan,"0",total_hpp,'Penjualan',new.no_faktur,"1",new.user);
                  

                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_hpp_penjualan,total_hpp,"0",'Penjualan',new.no_faktur,"1",new.user);

          END IF;


                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,new.cara_bayar,new.total,"0",'Penjualan',new.no_faktur,"1",new.user);


          IF (ppn_input = "Non") THEN

              SET total_penjualann = total2 + biaya_admin;

                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_total_penjualan,"0",total_penjualann,'Penjualan',new.no_faktur,"1",new.user);


          ELSEIF (ppn_input = "Include") THEN

            SET total_penjualann = (total2 + biaya_admin) - total_tax;
            SET pajak = total_tax;

              INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_total_penjualan,"0",total_penjualann,'Penjualan',new.no_faktur,"1",new.user);

              IF (pajak != 0 ) THEN

                INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_pajak_jual,"0",pajak,'Penjualan',new.no_faktur,"1",new.user);

                END IF;
                

          ELSE

            SET total_penjualann = (total2 + biaya_admin) - total_tax;
            SET pajak = total_tax;

                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_total_penjualan,"0",total_penjualann,'Penjualan',new.no_faktur,"1",new.user);


             IF (pajak != 0 ) THEN

                INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_pajak_jual,"0",pajak,'Penjualan',new.no_faktur,"1",new.user);

                END IF;

          END IF;


               IF (potongan != 0 ) THEN             

                    INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_potongan_jual,potongan,"0",'Penjualan',new.no_faktur,"1",new.user);

               END IF;



  ELSEIF(new.status_jual_awal = 'Kredit' || new.status_jual_awal = 'Simpan Sementara') THEN


          IF (total_hpp != "" || total_hpp != 0) THEN

                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_persediaan,"0",total_hpp,'Penjualan',new.no_faktur,"1",new.user);
                  

                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_hpp_penjualan,total_hpp,"0",'Penjualan',new.no_faktur,"1",new.user);

          END IF;


                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,new.cara_bayar,new.tunai,"0",'Penjualan',new.no_faktur,"1",new.user);


                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_pembayaran_kredit,total_piutang,"0",'Penjualan',new.no_faktur,"1",new.user);


          IF (ppn_input = "Non") THEN

              SET total_penjualann = total2 + biaya_admin;

                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_total_penjualan,"0",total_penjualann,'Penjualan',new.no_faktur,"1",new.user);



          ELSEIF (ppn_input = "Include") THEN

            SET total_penjualann = (total2 + biaya_admin) - total_tax;
            SET pajak = total_tax;

              INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_total_penjualan,"0",total_penjualann,'Penjualan',new.no_faktur,"1",new.user);

              IF (pajak != 0 ) THEN

                INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_pajak_jual,"0",pajak,'Penjualan',new.no_faktur,"1",new.user);

                END IF;
                


          ELSE 

            SET total_penjualann = (total2 + biaya_admin) - total_tax;
            SET pajak = total_tax;

                 INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_total_penjualan,"0",total_penjualann,'Penjualan',new.no_faktur,"1",new.user);


             IF (pajak != 0 ) THEN

                INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_pajak_jual,"0",pajak,'Penjualan',new.no_faktur,"1",new.user);

                END IF;

          END IF;


               IF (potongan != 0 ) THEN           

                  INSERT INTO jurnal_trans (nomor_jurnal,waktu_jurnal,keterangan_jurnal,kode_akun_jurnal,debit,kredit,jenis_transaksi,no_faktur,approved,user_buat) VALUES (new.no_faktur_jurnal,waktu,new.keterangan_jurnal,akun_potongan_jual,potongan,"0",'Penjualan',new.no_faktur,"1",new.user);
                  
               END IF;



  END IF;

END